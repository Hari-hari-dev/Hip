<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Daily Claim with Civic (Raw Web3)</title>
</head>
<body>
  <h1>Daily Claim Demo</h1>
  <p>Connect Phantom, then Initialize (admin), RegisterUser, and Claim!</p>

  <button id="connectBtn">Connect Phantom</button>
  <button id="initBtn">Initialize</button>
  <button id="regBtn">Register User</button>
  <button id="claimBtn">Claim</button>

  <pre id="log"></pre>

  <!-- 1) Load solana-web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js"></script>
  <!-- If you want a small sha256 function, you might load a library or do your own. -->

  <script>
    const PROGRAM_ID = new solanaWeb3.PublicKey("5XSKqwJreC1qdS96s6MSajbN4ts8oVrZ1S1r1BxKGWLH");
    // The minted token
    const MINT_ADDRESS = new solanaWeb3.PublicKey("58Ha7cnAzZ2V7t66ECAdBfy6fAxoFFwEwZP8eU7nrHHA");
    let walletPublicKey = null;

    const logEl = document.getElementById("log");
    function log(msg) {
      logEl.textContent += msg + "\n";
    }

    // Simple function to compute the 8-byte anchor discriminator
    // for "global:<ixName>" using a builtin or external library
    async function anchorDiscriminator(ixName) {
      const text = new TextEncoder().encode("global:" + ixName);
      const hashBuffer = await window.crypto.subtle.digest("SHA-256", text);
      return new Uint8Array(hashBuffer.slice(0, 8));
    }

    // We'll precompute them on page load
    let IX_INITIALIZE, IX_REGISTER, IX_CLAIM;
    (async () => {
      IX_INITIALIZE = await anchorDiscriminator("initialize");
      IX_REGISTER   = await anchorDiscriminator("register_user");
      IX_CLAIM      = await anchorDiscriminator("claim");
    })();

    const network = "https://api.devnet.solana.com"; // Or localnet/testnet
    const connection = new solanaWeb3.Connection(network);

    document.getElementById("connectBtn").onclick = async () => {
      if (!window.solana) {
        log("Phantom wallet not found!");
        return;
      }
      try {
        const resp = await window.solana.connect();
        walletPublicKey = resp.publicKey;
        log("Connected Phantom: " + walletPublicKey.toBase58());
      } catch (err) {
        log("Error connecting Phantom: " + err);
      }
    };

    document.getElementById("initBtn").onclick = async () => {
      if (!walletPublicKey) {
        log("Please connect Phantom first.");
        return;
      }
      // Build the Initialize tx
      try {
        await sendInitializeTx();
        log("Initialize successful.");
      } catch (err) {
        log("Initialize error: " + err);
      }
    };

    document.getElementById("regBtn").onclick = async () => {
      if (!walletPublicKey) {
        log("Please connect Phantom first.");
        return;
      }
      try {
        await sendRegisterUserTx();
        log("Register user successful.");
      } catch (err) {
        log("Register user error: " + err);
      }
    };

    document.getElementById("claimBtn").onclick = async () => {
      if (!walletPublicKey) {
        log("Please connect Phantom first.");
        return;
      }
      try {
        await sendClaimTx();
        log("Claim successful.");
      } catch (err) {
        log("Claim error: " + err);
      }
    };

    //--- The 3 TX builder functions follow, referencing the code from above: ---

    async function sendInitializeTx() {
      // Derive PDAs:
      const [settingsPda] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode("settings")],
        PROGRAM_ID
      );
      const [mintAuthPda] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode("settings"), new TextEncoder().encode("mint_authority")],
        PROGRAM_ID
      );

      const keys = [
        { pubkey: settingsPda,   isSigner: false, isWritable: true },
        { pubkey: mintAuthPda,   isSigner: false, isWritable: false },
        { pubkey: MINT_ADDRESS,  isSigner: false, isWritable: true },
        { pubkey: walletPublicKey, isSigner: true, isWritable: true },
        { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
        { pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
      ];

      const data = Buffer.from(IX_INITIALIZE);

      const ix = new solanaWeb3.TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
      });

      const tx = new solanaWeb3.Transaction().add(ix);
      tx.feePayer = walletPublicKey;
      tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

      const signedTx = await window.solana.signTransaction(tx);
      const txSig = await connection.sendRawTransaction(signedTx.serialize());
      await connection.confirmTransaction(txSig);
      log("Initialize Tx Sig: " + txSig);
    }

    async function sendRegisterUserTx() {
      const [settingsPda] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode("settings")],
        PROGRAM_ID
      );
      const [userPda] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode("user"), walletPublicKey.toBuffer()],
        PROGRAM_ID
      );

      const keys = [
        { pubkey: settingsPda, isSigner: false, isWritable: false },
        { pubkey: userPda,     isSigner: false, isWritable: true },
        { pubkey: walletPublicKey, isSigner: true, isWritable: true },
        { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
        { pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
      ];

      const data = Buffer.from(IX_REGISTER);

      const ix = new solanaWeb3.TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
      });

      const tx = new solanaWeb3.Transaction().add(ix);
      tx.feePayer = walletPublicKey;
      tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

      const signedTx = await window.solana.signTransaction(tx);
      const txSig = await connection.sendRawTransaction(signedTx.serialize());
      await connection.confirmTransaction(txSig);
      log("RegisterUser Tx Sig: " + txSig);
    }

    async function sendClaimTx() {
      const [settingsPda] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode("settings")],
        PROGRAM_ID
      );
      const [userPda] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode("user"), walletPublicKey.toBuffer()],
        PROGRAM_ID
      );
      const [mintAuthPda] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode("settings"), new TextEncoder().encode("mint_authority")],
        PROGRAM_ID
      );

      // If using the associated token program, you'd want to find the user's ATA for MINT_ADDRESS
      // We'll just do a placeholder or a real derivation:
      const recipientTokenAccount = await solanaWeb3.PublicKey.findProgramAddress(
        // In practice, use SPL-Token v0.3.14 getAssociatedTokenAddress
        // e.g. getAssociatedTokenAddress(MINT_ADDRESS, walletPublicKey)
        // This is just a placeholder. Replace with your actual ATA
        // ...
      );
      const gatewayTokenAddress = new solanaWeb3.PublicKey("YourCivicGatewayTokenAddress");

      const keys = [
        { pubkey: settingsPda, isSigner: false, isWritable: false },
        { pubkey: userPda, isSigner: false, isWritable: true },
        { pubkey: walletPublicKey, isSigner: true, isWritable: true },
        { pubkey: MINT_ADDRESS, isSigner: false, isWritable: true },
        { pubkey: mintAuthPda, isSigner: false, isWritable: false },
        { pubkey: recipientTokenAccount, isSigner: false, isWritable: true },
        { pubkey: gatewayTokenAddress, isSigner: false, isWritable: false },
        { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
        { pubkey: solanaWeb3.TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
        { pubkey: solanaWeb3.ASSOCIATED_TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
        { pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
      ];

      const data = Buffer.from(IX_CLAIM);

      const ix = new solanaWeb3.TransactionInstruction({
        programId: PROGRAM_ID,
        keys,
        data,
      });

      const tx = new solanaWeb3.Transaction().add(ix);
      tx.feePayer = walletPublicKey;
      tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

      const signedTx = await window.solana.signTransaction(tx);
      const txSig = await connection.sendRawTransaction(signedTx.serialize());
      await connection.confirmTransaction(txSig);
      log("Claim Tx Sig: " + txSig);
    }
  </script>
</body>
</html>
